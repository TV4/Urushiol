#!/usr/bin/env ruby
require 'urushiol'
require 'test_case'
require 'pathname'

def run_testfile file_ref
  test = TestCase.new file_ref

  puts "\nRunning test #{Pathname.new(file_ref).basename} :  "

  test.instance_eval("def run \n #{IO.read(file_ref)} \nend")
  test.run
end

def create_test_file test_name
  out_file = File.new("#{test_name}.uru", "w")
  out_file << IO.readlines("#{root_path}meta/test_skeleton.uru").join('')
  out_file.close

  puts "#{test_name}.uru successfully created."
end

def root_path
  File.dirname(__FILE__).to_s+"/../"
end





if ARGV.empty?
  puts "Welcome to Urushiol. The easy test framework for varnish vcl files."

elsif ARGV.first.downcase == "integritycheck"
  Dir.glob("#{root_path}test/**/*").each do |testfile|
    run_testfile testfile
  end
elsif ARGV.first == "generate"
  if ARGV[1] != nil
    create_test_file(ARGV[1])
  else
    puts "Please specify a name for your test."
  end
elsif File.exists? ARGV.first
  ARGV.each do |testfile|
    if File.exists? testfile
      run_testfile testfile
    end
  end
else
  puts "Urushiol did not recognize \"#{ARGV.join(" ")} \" as argument(s)."

end







